# AMD64 와 ARM64 이슈
- docker를 자주 사용하는 사람이라면 또는 kubernetes를 자주 사용하는 사람이라면 가끔 한번씩 등장하는 이슈일 것 이다. 
- 나 역시 kubernetes에서 amd64 or arm64 이슈가 생겼었다. 처음 쿠버네티스에서 이슈를 보았을 때 이 문제는 아닐 줄 알았는데 애플리케이션을 올릴 때 initcontainer에서 shell script를 실행시키는 command가 있는데 자세히 보니까 해당 이슈였던 것 

### 특정 컨테이너 로그 보는법
```agsl
kubectl logs pod name -c container name
```
해당 명령어로 initcontainer에 문제가 있다는것을 알았다.

## AMD64과 ARM64는 무엇인가 ? 
- 자세하게는 설명을 못하지만 한번 찾아봤다.
- AMD64는 64비트 아키텍처이다. 거의 최신 pc와 서버에서 사용한다고 한다. 이점은 64비트 처리와 메모리 주소 공간을 지원 32비트 시스템보다 높은 메모리 용량과 높은 처리 성능을 제공한다고 한다.
- AMD64 x86-64는 무엇일까? x86 아키텍처의 확장 버전 x86 호환코드와 프로그램을 지원
- x86(IA-32) 32비트 아키텍처로 이전 세대의 pc와 서버에서 사용

ARM(Advanced RISC Machines)
- 저전력 임베디드 시스템이나 모바일 기기에서 사용
- RISC 아키텍쳐로 명령어 세트가 간결
- ARM 프로세서는 다양한 코어 수와 주파수로 제공 특정 애플리케이션에 적합한 최적의 프로세서를 선택할 수 있다.
- ARM 기반 시스템은 최대 64비트 처리와 메모리 주소를 지원 최신 ARM 프로세서는 높은 처리 성능을 제공 
- 주로 대규모 데이터베이스, 웹서버 등등에서 사용 

### 그러면 무슨 어떤 차이가 있는가? 
- amd64 아키텍처와 ARM 아키텍처는 서로 다른 설계 철학을 가지고 있다고 한다. 
- AMD64는 고성능 서버와 pc에서 사용하고 대부분 소프트웨어가 이 아키텍처를 지원한다고 함.
- ARM 아키텍처는 대부분 모바일 기기와 임베디드 시스템에서 사용 이 아키텍처는 전력 소모가 적고 단순한 명령어 구조를 가지고 있기 때문 그래서 고성능 작업에는 적합하지 않다.

### 이슈
- AMD64 64비트 운영체제 Mac os M1칩은 apple에서 개발함 intel과 다른 ARM CPU라는 점 
  - amd64 x86_64=x64 = 64비트

## 그러면 왜 이게 docker에서나 kubernetes에서나 문제가 생기는거지? 
- docker에서는 이미지를 빌드할 때 생길 것이다. 아마도 m1은 arm64기반이라서 ubuntu에서 열리지 않는 것이다.
- m1에서 빌드할 때 amd 기반으로 빌드할 수 있게 docker buildx를 사용하자
```agsl
# 참고 명령어
docker buildx build --platform linux/adm64 --load -t
```
### 다시 돌아와서 왜 문제가 생길까
- 내가 생각했을 때 우리 팀에서는 우리가 사용하는 애플리케이션을 이미지를 tar로 만든다. 해당 이미지는 arm64 아키텍처 기반 이미지로 만들어져서 private registry habor로 이미지가 올라가고
해당 이미지를 amd64 아키텍처 기반인 os에서 실행시키려고 하니 에러가 났을거라고 생각이 든다. 아니면 그와반대로 amd에서 이미지를 말고 도커를 실행하는 환경에서는 arm 환경이기 때문에 실행이 안된거 같다.
- 쿠버네티스도 컨테이너를 워커노드에서 실행을 시키기 때문에 해당 워커노드가 어떤 아키텍처로 운영되고 있는지 확인을 해야한다. 
- 쿠버네티스에서 쉘 스크립트를 실행 시킬 때 에러는 아래 내용이였다. 
```agsl
exec /usr/bin/sh: exec format error 
```
이것도 역시 쉘 스크립트 문제 일거같지만 같은이유이다. amd기반에서 이미지를 말아서 arm 아키텍처에서 실행하거나 arm 기반에서 이미지를 말아서 amd 아키텍처 기반에서 실행시키거나 둘중 하나일것이다. 



